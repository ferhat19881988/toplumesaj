<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modern WhatsApp Toplu Mesaj</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --gap:12px; --radius:12px; --bg:#f8fafc; --text:#0f172a; --card:#ffffff;
      --muted:#f1f5f9; --border:#e2e8f0; --primary:#2563eb; --primary-hover:#1d4ed8;
      --danger:#ef4444; --success:#22c55e; --shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{height:100%}
    body{ font-family: 'Inter', system-ui, -apple-system, sans-serif; margin:0; background:var(--bg); color:var(--text); }
    .container{max-width:1100px; margin:32px auto; padding:0 20px;}
    h1{margin:0 0 20px; font-size:26px; font-weight:700; color:var(--text);}
    
    .card{ background:var(--card); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow); margin-bottom:20px; border:1px solid var(--border); }
    .row{ display:grid; grid-template-columns:repeat(12, minmax(0,1fr)); gap:var(--gap); align-items:end; }
    .flex-1{ grid-column:span 4; } .flex-2{ grid-column:span 8; }
    @media (max-width: 820px){ .flex-2, .flex-1{ grid-column:1 / -1; } }

    /* Modern File Upload Zone */
    .drop-zone {
      border: 2px dashed var(--border); border-radius: var(--radius);
      padding: 30px; text-align: center; cursor: pointer;
      transition: all 0.2s ease; background: #f8fafc;
    }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--primary); background: #eff6ff; }
    .drop-zone p { margin: 0; color: #64748b; font-weight: 500; pointer-events: none; }
    .drop-zone input[type="file"] { display: none; }

    label{ display:block; font-weight:600; font-size:13px; margin-bottom:6px; color:#475569; }
    input[type="text"], textarea, select, input[type="number"]{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; 
      background:#fff; font-size:14px; transition:all .2s;
    }
    textarea{ min-height:100px; resize:vertical; line-height:1.5; }
    input:focus, textarea:focus, select:focus{ border-color:var(--primary); outline:3px solid rgba(37,99,235,.1); }
    
    button{
      padding:10px 16px; border-radius:8px; border:0; cursor:pointer; font-weight:600; font-size:14px;
      transition:all .2s; background:var(--muted); color:#475569;
    }
    button:hover{ background:#e2e8f0; }
    button:active{ transform:scale(0.98); }
    button:disabled{ opacity:.5; cursor:not-allowed; pointer-events: none; }
    
    .primary{ background:var(--primary); color:#fff; }
    .primary:hover{ background:var(--primary-hover); }
    .danger{ background:var(--danger); color:#fff; }
    .danger:hover{ background:#dc2626; }

    .table-wrap{ max-height:450px; overflow:auto; border:1px solid var(--border); border-radius:10px; }
    table{ width:100%; border-collapse:collapse; background:#fff; }
    th,td{ border-bottom:1px solid var(--border); padding:12px; font-size:13px; text-align:left; }
    th{ position:sticky; top:0; z-index:10; background:#f1f5f9; font-weight:700; color:#334155; }
    tr:hover{ background:#f8fafc; }
    
    .badge{ display:inline-flex; align-items:center; padding:2px 10px; border-radius:99px; font-size:12px; font-weight:600; background:var(--muted); color:#475569; }
    .badge.green { background: #dcfce7; color: #166534; }
    
    .log{
      font-family: 'Menlo', monospace; font-size:12px; background:#1e293b; color:#cbd5e1;
      border-radius:8px; padding:12px; max-height:150px; overflow-y:auto; margin-top:10px;
    }
    .mode-group{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; background:var(--muted); padding:8px; border-radius:8px; }
    .hint{ font-size:12px; color:#64748b; margin-top:6px; line-height:1.4; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h1>WhatsApp Toplu Mesaj</h1>
        <span class="badge" id="versionBadge">v2.0 (Offline Mode)</span>
    </div>

    <div class="card">
      <div class="drop-zone" id="dropZone">
        <p>üìÇ Excel (.xlsx) veya CSV dosyasƒ±nƒ± buraya s√ºr√ºkleyin veya tƒ±klayƒ±p se√ßin</p>
        <small style="color:#94a3b8; display:block; margin-top:5px;">S√ºtun Ba≈ülƒ±klarƒ± √ñnerisi: NO, ADSOYAD, SINIF, TELEFON, MESAJ</small>
        <input type="file" id="fileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="flex-2">
          <label for="tpl">Mesaj ≈ûablonu</label>
          <textarea id="tpl">Merhaba, {ADSOYAD} ({SINIF}) √∂ƒürencimiz i√ßin bilgilendirme: {MESAJ}</textarea>
        </div>
        <div class="flex-1">
          <label for="countryCode">√úlke Kodu</label>
          <input id="countryCode" type="number" value="90" placeholder="√ñrn: 90" />
          <div style="height:12px"></div>
          <label for="intervalSec">G√∂nderim Aralƒ±ƒüƒ± (Saniye)</label>
          <input id="intervalSec" type="number" min="2" value="6" />
          <div style="height:12px"></div>
          <label for="classFilter">Sƒ±nƒ±f Filtresi</label>
          <select id="classFilter" disabled><option value="">‚Äî √ñnce Dosya Y√ºkleyin ‚Äî</option></select>
        </div>
      </div>

      <div class="row" style="margin-top:20px;">
        <div class="flex-2">
          <label>ƒ∞lerleme Y√∂ntemi</label>
          <div class="mode-group">
            <label><input type="radio" name="advanceMode" value="timer" checked> ‚è≥ Zamanlayƒ±cƒ±</label>
            <label><input type="radio" name="advanceMode" value="onclose"> ‚ùå Sekme Kapanƒ±nca</label>
            <label><input type="radio" name="advanceMode" value="hotkey"> ‚å®Ô∏è Tu≈üla (Shift+Enter)</label>
            <button id="btnAdvance" class="primary" style="padding:4px 10px; font-size:12px;" disabled>Sƒ±radaki ‚ñ∏</button>
          </div>
          <div class="hint">
            <b>Zamanlayƒ±cƒ±:</b> Otomatik bekler ve a√ßar. <b>Sekme Kapanƒ±nca:</b> Siz WhatsApp sekmesini kapatƒ±nca yenisi a√ßƒ±lƒ±r. <b>Tu≈üla:</b> Kontrol sizde.
          </div>
        </div>
        <div class="flex-1" style="text-align:right; align-self:center;">
           <div id="stats" class="badge">0 kayƒ±t</div>
        </div>
      </div>

      <div class="row" style="margin-top:20px; border-top:1px solid var(--border); padding-top:16px;">
        <div class="flex-2">
           <button id="btnStart" class="primary" disabled>üöÄ G√∂nderimi Ba≈ülat</button>
           <button id="btnPause" class="muted">Duraklat</button>
           <button id="btnReset" class="danger">Sƒ±fƒ±rla</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th width="40"><input type="checkbox" id="selectAll" disabled></th>
              <th>No</th>
              <th>Ad Soyad</th>
              <th>Sƒ±nƒ±f</th>
              <th>Telefon</th>
              <th>Mesaj</th>
              <th>Durum</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7" style="text-align:center; color:#94a3b8; padding:20px;">Veri g√∂r√ºnt√ºlemek i√ßin yukarƒ±dan dosya se√ßiniz.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="log" id="log">Sistem hazƒ±r. Dosya bekleniyor...</div>
    </div>
  </div>

<script>
/* ---- YARDIMCI FONKSƒ∞YONLAR ---- */
const $ = sel => document.querySelector(sel);
const log = (m) => { const box = $('#log'); const time = new Date().toLocaleTimeString(); box.innerHTML += `<div><span style="color:#64748b">[${time}]</span> ${m}</div>`; box.scrollTop = box.scrollHeight; };
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

/* T√ºrk√ße karakter normalizasyonu ve ba≈ülƒ±k e≈üle≈ütirme */
function normalizeHeader(h) {
  return (h || '').toString().trim().toLowerCase('tr')
    .normalize('NFD').replace(/\p{Diacritic}/gu,'')
    .replace(/\s+/g,'').replace(/[^a-z0-9]/g,'');
}

/* Telefon Numarasƒ± Temizleme */
function normalizePhone(raw, countryCode='90') {
  let d = (raw || '').toString().replace(/\D+/g,'');
  if (!d) return '';
  if (d.startsWith('00')) d = d.slice(2);
  if (d.startsWith(countryCode)) return d;
  if (d.length === 10) return countryCode + d; // Ba≈üƒ±nda 0 yoksa (5XX...)
  if (d.length === 11 && d.startsWith('0')) return countryCode + d.slice(1); // 05XX ise
  return d;
}

/* Dinamik Template Doldurma */
function fillTemplate(tpl, row) {
  // Kullanƒ±cƒ± s√ºtun isimlerini b√ºy√ºk/k√º√ß√ºk harf yazsa da yakalamak i√ßin
  const safeRow = {};
  Object.keys(row).forEach(k => safeRow[k.toUpperCase()] = row[k]);
  
  return tpl.replace(/\{(\w+)\}/g, (_, k) => {
    const key = k.toUpperCase();
    return safeRow[key] ?? '';
  });
}

function buildWhatsAppUrl(phone, text) {
  return `https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(text)}`;
}

/* ---- STATE Y√ñNETƒ∞Mƒ∞ ---- */
const state = {
  rows: [], // ƒ∞≈ülenmi≈ü veriler
  queue: [], // G√∂nderilecek indeksler
  paused: false,
  waWin: null,
  advanceMode: 'timer',
  advanceResolver: null
};

/* ---- DOSYA ƒ∞≈ûLEME (EXCEL/CSV) ---- */
const dropZone = $('#dropZone');
const fileInput = $('#fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', (e) => {
  if(e.target.files.length) handleFile(e.target.files[0]);
});

async function handleFile(file) {
  log(`Dosya okunuyor: ${file.name}`);
  const reader = new FileReader();
  
  reader.onload = (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      
      // Veriyi "Array of Arrays" olarak al (Header manip√ºlasyonu i√ßin daha g√ºvenli)
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
      
      if(jsonData.length < 2) throw new Error("Dosyada yeterli veri yok.");
      
      processData(jsonData);
    } catch(err) {
      alert("Dosya okunamadƒ±: " + err.message);
      log("Hata: " + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function processData(rawRows) {
  // 1. Ba≈ülƒ±klarƒ± bul ve e≈üle≈ütir
  const headers = rawRows[0];
  const map = buildMapper(headers);
  
  // 2. Veriyi objeye √ßevir
  state.rows = [];
  for(let i=1; i<rawRows.length; i++) {
    const r = rawRows[i];
    if(!r || r.length === 0) continue;
    
    // E≈üle≈üen s√ºtunlarƒ± al, yoksa bo≈ü string ata
    const obj = {
      NO: r[map.NO] || '',
      ADSOYAD: r[map.ADSOYAD] || '',
      SINIF: r[map.SINIF] || '',
      TELEFON: r[map.TELEFON] || '',
      MESAJ: r[map.MESAJ] || '' // √ñzel mesaj s√ºtunu varsa
    };
    
    // Eƒüer satƒ±r tamamen bo≈üsa atla
    if(!Object.values(obj).some(val => val)) continue;
    
    state.rows.push(obj);
  }

  log(`${state.rows.length} ki≈üi y√ºklendi.`);
  renderTable();
  updateFilters();
  $('#btnStart').disabled = false;
  $('#selectAll').disabled = false;
  $('#selectAll').checked = true;
}

function buildMapper(headers) {
  const map = { NO:-1, ADSOYAD:-1, SINIF:-1, TELEFON:-1, MESAJ:-1 };
  const aliases = {
    NO: ['no','numara','id','ogrno'],
    ADSOYAD: ['ad','soyad','isim','adsoyad','adisoyadi','ogrenci'],
    SINIF: ['sinif','sinifi','sube','derece'],
    TELEFON: ['tel','cep','gsm','telefon','iletisim','mobile'],
    MESAJ: ['mesaj','not','aciklama','text']
  };
  
  const normHeaders = headers.map(normalizeHeader);
  
  for (const [key, list] of Object.entries(aliases)) {
    // √ñnce tam e≈üle≈üme, sonra i√ßerik aramasƒ±
    let idx = normHeaders.findIndex(h => list.includes(h));
    if(idx === -1) idx = normHeaders.findIndex(h => list.some(l => h.includes(l)));
    map[key] = idx;
  }
  return map;
}

/* ---- ARAY√úZ G√úNCELLEME ---- */
function renderTable() {
  const tbody = $('#tbl tbody');
  tbody.innerHTML = '';
  const tpl = $('#tpl').value;
  const filter = $('#classFilter').value;
  const cc = $('#countryCode').value;

  state.rows.forEach((row, idx) => {
    // Filtreleme
    if(filter && (row.SINIF||'').toString() !== filter) return;

    const phone = normalizePhone(row.TELEFON, cc);
    const msg = fillTemplate(tpl, row);
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="rowchk" data-idx="${idx}" ${phone ? 'checked' : ''} ${!phone ? 'disabled' : ''}></td>
      <td>${row.NO}</td>
      <td>${row.ADSOYAD}</td>
      <td><span class="badge">${row.SINIF}</span></td>
      <td>${row.TELEFON} ${!phone ? '<b style="color:red">(!)</b>' : ''}</td>
      <td style="font-size:12px; color:#64748b; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${msg}</td>
      <td id="status-${idx}">-</td>
    `;
    tbody.appendChild(tr);
  });
  
  $('#stats').textContent = `${document.querySelectorAll('.rowchk:checked').length} se√ßili`;
}

function updateFilters() {
  const classes = new Set(state.rows.map(r => r.SINIF).filter(Boolean));
  const sel = $('#classFilter');
  sel.innerHTML = '<option value="">‚Äî Hepsi ‚Äî</option>';
  [...classes].sort().forEach(c => {
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    sel.appendChild(opt);
  });
  sel.disabled = false;
}

/* ---- ETKƒ∞LE≈ûƒ∞MLER ---- */
$('#tpl').addEventListener('input', renderTable);
$('#classFilter').addEventListener('change', renderTable);
$('#countryCode').addEventListener('change', renderTable);
$('#selectAll').addEventListener('change', (e) => {
  document.querySelectorAll('.rowchk:not(:disabled)').forEach(c => c.checked = e.target.checked);
  $('#stats').textContent = `${document.querySelectorAll('.rowchk:checked').length} se√ßili`;
});

/* ---- G√ñNDERƒ∞M MOTORU ---- */
function waitAdvanceSignal() {
  return new Promise(resolve => {
    state.advanceResolver = () => { state.advanceResolver = null; resolve(); };
    $('#btnAdvance').disabled = false;
    $('#btnAdvance').classList.remove('muted');
    $('#btnAdvance').classList.add('primary');
  });
}

function triggerAdvance() {
  if (typeof state.advanceResolver === 'function') {
    $('#btnAdvance').disabled = true;
    state.advanceResolver();
  }
}

async function startQueue() {
  state.queue = [...document.querySelectorAll('.rowchk:checked')].map(c => parseInt(c.dataset.idx));
  if(!state.queue.length) { alert("L√ºtfen listeden ki≈üi se√ßin."); return; }
  
  $('#btnStart').disabled = true;
  $('#dropZone').style.pointerEvents = 'none'; // Dosya y√ºklemeyi kilitle
  
  const cc = $('#countryCode').value;
  const tpl = $('#tpl').value;
  const interval = Math.max(2, parseInt($('#intervalSec').value));
  const mode = state.advanceMode;
  
  log(`Ba≈ülatƒ±lƒ±yor... Toplam: ${state.queue.length} ki≈üi.`);
  
  for(let i=0; i<state.queue.length; i++) {
    const rowIdx = state.queue[i];
    const row = state.rows[rowIdx];
    
    // Duraklatma kontrol√º
    while(state.paused) { 
        $('#status-' + rowIdx).innerHTML = '<span style="color:orange">Duraklatƒ±ldƒ±...</span>';
        await sleep(500); 
    }

    // Durum G√ºncelle
    const statusCell = $('#status-' + rowIdx);
    statusCell.innerHTML = '‚è≥ Hazƒ±rlanƒ±yor...';
    
    // Mesajƒ± olu≈ütur
    const cleanPhone = normalizePhone(row.TELEFON, cc);
    const fullMsg = fillTemplate(tpl, row);
    const url = buildWhatsAppUrl(cleanPhone, fullMsg);
    
    // ƒ∞lerleme Mantƒ±ƒüƒ± (ƒ∞lk ki≈üi hari√ß bekleme yapar)
    if(i > 0) {
      if(mode === 'timer') {
         let timeLeft = interval;
         while(timeLeft > 0) {
             statusCell.innerHTML = `‚è≥ Bekleniyor (${timeLeft}s)`;
             await sleep(1000);
             timeLeft--;
         }
      } else if(mode === 'onclose') {
         log("√ñnceki sekmenin kapatƒ±lmasƒ± bekleniyor...");
         while(state.waWin && !state.waWin.closed) { await sleep(500); }
      } else if(mode === 'hotkey') {
         statusCell.innerHTML = '‚å®Ô∏è Tu≈ü Bekleniyor...';
         await waitAdvanceSignal();
      }
    }

    // Pencereyi A√ß
    log(`G√∂nderiliyor: ${row.ADSOYAD}`);
    state.waWin = window.open(url, 'wa_bulk');
    
    if(!state.waWin) {
      alert("Pop-up engellendi! L√ºtfen izin verin.");
      statusCell.innerHTML = '<span style="color:red">Engellendi</span>';
      break;
    }
    
    statusCell.innerHTML = '<span class="badge green">A√ßƒ±ldƒ±</span>';
  }
  
  log("T√ºm g√∂nderimler tamamlandƒ±.");
  $('#btnStart').disabled = false;
  $('#dropZone').style.pointerEvents = 'all';
}

$('#btnStart').addEventListener('click', startQueue);
$('#btnPause').addEventListener('click', () => {
  state.paused = !state.paused;
  $('#btnPause').textContent = state.paused ? 'Devam Et' : 'Duraklat';
  $('#btnPause').classList.toggle('primary');
});
$('#btnReset').addEventListener('click', () => {
  location.reload();
});

// ƒ∞lerleme modu deƒüi≈üimi
document.querySelectorAll('input[name="advanceMode"]').forEach(r => {
  r.addEventListener('change', (e) => { state.advanceMode = e.target.value; });
});

// Klavye Kƒ±sayolu ve Buton
$('#btnAdvance').addEventListener('click', triggerAdvance);
document.addEventListener('keydown', (e) => {
  if (state.advanceMode === 'hotkey' && e.key === 'Enter' && e.shiftKey) {
    e.preventDefault();
    triggerAdvance();
  }
});
</script>
</body>
</html>
